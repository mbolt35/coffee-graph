#!/usr/bin/env node

// TODO: Since we require Java 6 here, we should add checks the runtime.
// TODO: It's also possible that java doesn't exist on their path, in which
// TODO: case, we'd need to attempt to find it.

var windows = require('os').type().toLowerCase().indexOf("windows") != -1;
var exec = require('child_process').exec;
var path  = require('path');
var fs = require('fs');

// For windows directories. Converts "C:\Foo\" -> "C:\Foo"
function trim(file) {
  if (file.indexOf('"') != -1) {
    return file.replace('"', '');
  }
  
  return file;
}

// Wraps the String in Quotations
function wrap(file) {
  return '"' + file + '"';
}

// Uses the fs and path modules to determine the real directory name
function realDir(file) {
  return path.dirname(fs.realpathSync(file));
}

// Determine if the argument is an option
function isOption(arg) {
  return arg.charAt(0) === "-";
}

// Fix-up any potential windows file system madness.
function processArguments(args) {
  var result = args.slice(2);
  if (!windows) {
    return result;
  }
  
  for (var i = 0; i < result.length; ++i) {
    result[i] = trim(result[i]);
    
    if (!isOption(result[i])) {
      result[i] = wrap(fs.realpathSync(result[i]));
    }
  }
  
  return result;
}

// Execution callback
function handleOutput(error, stdout, stderr) {
  if (error) {
    console.log(error);
  } else if (stdout) {
    console.log(stdout);
  } else if (stderr) {
    console.log(stderr);
  }
}

var args = processArguments(process.argv).join(' ');
var jar = wrap( path.join(realDir(__filename), 'jar', '/coffee-graph.jar') );

exec('java -jar ' + jar + ' ' + args, handleOutput);
